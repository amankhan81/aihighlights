<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CricketScanPro AI | Autonomous Production Suite</title>
    
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & Babel Standalone -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-[#020617]">
    <div id="root"></div>

    <script type="text/babel">
        // =============================================================
        // STEP 1: CONFIGURE YOUR KEYS HERE
        // =============================================================
        
        // 1. Paste your Firebase Config Object from the Firebase Console
        const myFirebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // 2. Paste your Google AI Studio API Key (for Gemini)
        const myGeminiApiKey = "YOUR_GEMINI_API_KEY";

        // =============================================================
        // APP LOGIC
        // =============================================================
        const { useState, useRef, useEffect } = React;

        // Initialize Firebase (Compat version for CDN use)
        firebase.initializeApp(myFirebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "cricket-scan-pro-v4";
        const apiKey = myGeminiApiKey;

        // --- UTILS ---
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        const getColorDistance = (c1, c2) =>
            Math.sqrt(Math.pow(c1.r - c2.r, 2) + Math.pow(c1.g - c2.g, 2) + Math.pow(c1.b - c2.b, 2));

        const getAverageColor = (ctx, region) => {
            const data = ctx.getImageData(region.x, region.y, region.width, region.height).data;
            let r = 0, g = 0, b = 0, total = data.length / 4;
            for (let i = 0; i < data.length; i += 4) {
                r += data[i]; g += data[i + 1]; b += data[i + 2];
            }
            return { r: Math.floor(r / total), g: Math.floor(g / total), b: Math.floor(b / total) };
        };

        function pcmToWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(0, 'RIFF');
            view.setUint32(4, 32 + pcmData.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcmData.length * 2, true);
            for (let i = 0; i < pcmData.length; i++) view.setInt16(44 + i * 2, pcmData[i], true);
            return new Blob([buffer], { type: 'audio/wav' });
        }

        const HighlightCard = ({ highlight, onSelect, onDelete, onCommentate, isActive, isProcessing }) => (
            <div
                onClick={() => onSelect(highlight)}
                className={`group relative flex flex-col bg-slate-800/40 backdrop-blur-sm rounded-xl overflow-hidden cursor-pointer border transition-all duration-300 ${isActive ? 'border-emerald-500 scale-[1.02] shadow-[0_0_15px_rgba(16,185,129,0.2)]' : 'border-white/5 hover:border-white/20'}`}
            >
                <div className="relative aspect-video bg-black">
                    {highlight.thumbnail && (
                        <img src={highlight.thumbnail} alt="Moment" className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" />
                    )}
                    <div className="absolute top-2 left-2 px-2 py-0.5 rounded-full bg-emerald-500 text-[8px] font-black uppercase tracking-wider text-slate-950">
                        {String(highlight.label)}
                    </div>
                    <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-all">
                        <button onClick={(e) => { e.stopPropagation(); onCommentate(highlight); }} disabled={isProcessing} className="w-7 h-7 flex items-center justify-center bg-indigo-600 rounded-lg hover:bg-indigo-500">
                            <i className={`fa-solid ${isProcessing ? 'fa-spinner fa-spin' : 'fa-microphone-lines'} text-[10px]`}></i>
                        </button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(highlight.id); }} className="w-7 h-7 flex items-center justify-center bg-red-600/80 rounded-lg hover:bg-red-500">
                            <i className="fa-solid fa-trash-can text-[10px]"></i>
                        </button>
                    </div>
                    <div className="absolute bottom-2 right-2 px-1.5 py-0.5 rounded-md bg-black/80 text-[9px] font-mono text-emerald-400">
                        {formatTime(highlight.startTime)}
                    </div>
                </div>
                <div className="p-2">
                    <h4 className="text-[9px] font-bold text-slate-100 uppercase tracking-widest truncate">
                        Event @ {formatTime(highlight.timestamp)}
                    </h4>
                    {highlight.commentary && (
                        <p className="text-[9px] text-slate-400 mt-1 leading-tight italic line-clamp-2">
                            "{String(highlight.commentary)}"
                        </p>
                    )}
                </div>
            </div>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [videoUrl, setVideoUrl] = useState('');
            const [highlights, setHighlights] = useState([]);
            const [triggers, setTriggers] = useState([]);
            const [isScanning, setIsScanning] = useState(false);
            const [isVisionScanning, setIsVisionScanning] = useState(false);
            const [isExporting, setIsExporting] = useState(false);
            const [activeAIId, setActiveAIId] = useState(null);
            const [progress, setProgress] = useState(0);
            const [currentHighlight, setCurrentHighlight] = useState(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [startPos, setStartPos] = useState({ x: 0, y: 0 });
            const [currentRect, setCurrentRect] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [pendingColor, setPendingColor] = useState(null);
            const [triggerName, setTriggerName] = useState('Boundary');
            const [settings, setSettings] = useState({ scanSpeed: 5, preRoll: 10, clipDuration: 15, tolerance: 45 });

            const videoRef = useRef(null);
            const containerRef = useRef(null);
            const abortRef = useRef(false);
            const lastDetectionTimeRef = useRef(-10);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    if (u) {
                        setUser(u);
                        const projectRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('projects').doc('main');
                        projectRef.onSnapshot((doc) => {
                            if (doc.exists) setTriggers(doc.data().triggers || []);
                        });
                    } else {
                        auth.signInAnonymously();
                    }
                });
                return () => unsubscribe();
            }, []);

            const saveProjectToCloud = async (newTriggers) => {
                if (!user) return;
                const projectRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('projects').doc('main');
                await projectRef.set({ triggers: newTriggers, lastUpdated: Date.now() }, { merge: true });
            };

            const geminiFetch = async (endpoint, payload, retries = 5) => {
                let delay = 1000;
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${endpoint}?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error("API Request failed");
                        return await response.json();
                    } catch (err) {
                        if (i === retries - 1) throw err;
                        await new Promise(r => setTimeout(r, delay));
                        delay *= 2;
                    }
                }
            };

            const runVisionEventScan = async () => {
                if (!videoUrl || !videoRef.current) return;
                setIsVisionScanning(true);
                abortRef.current = false;
                const video = videoRef.current;
                const duration = video.duration;
                const interval = Math.max(1, 11 - settings.scanSpeed);
                
                for (let t = 0; t < duration; t += interval) {
                    if (abortRef.current) break;
                    setProgress((t / duration) * 100);
                    video.currentTime = t;
                    await new Promise(r => video.onseeked = r);

                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    const base64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];

                    try {
                        const result = await geminiFetch('gemini-2.5-flash-preview-09-2025:generateContent', {
                            contents: [{
                                parts: [
                                    { text: "Examine the center-middle area of this cricket broadcast frame. Is there a graphic pop-up indicating a '6', '4', 'OUT', or a full 'SCORECARD'? Respond with JUST the keyword: 'SIX', 'FOUR', 'OUT', or 'SCORECARD'. If nothing is found, respond 'NONE'." },
                                    { inlineData: { mimeType: "image/jpeg", data: base64 } }
                                ]
                            }]
                        });
                        const label = String(result.candidates?.[0]?.content?.parts?.[0]?.text || "NONE").trim().toUpperCase();
                        if (label !== 'NONE' && label.length < 20) {
                            setHighlights(prev => {
                                if (prev.find(h => Math.abs(h.timestamp - t) < 10)) return prev;
                                const startTime = Math.max(0, t - settings.preRoll);
                                return [...prev, {
                                    id: `vision-${t}-${Date.now()}`,
                                    timestamp: t,
                                    label: label,
                                    startTime: startTime,
                                    endTime: Math.min(duration, startTime + settings.clipDuration),
                                    thumbnail: canvas.toDataURL('image/jpeg', 0.4)
                                }];
                            });
                        }
                    } catch (e) { console.error(e); }
                }
                setIsVisionScanning(false);
            };

            const generateCommentary = async (highlight) => {
                setActiveAIId(highlight.id);
                try {
                    const result = await geminiFetch('gemini-2.5-flash-preview-09-2025:generateContent', {
                        contents: [{
                            parts: [
                                { text: `Write a short, high-energy cricket commentary line (max 12 words) for this ${highlight.label} moment. Sound professional like a match broadcaster.` },
                                { inlineData: { mimeType: "image/jpeg", data: highlight.thumbnail.split(',')[1] } }
                            ]
                        }]
                    });
                    const commentary = String(result.candidates?.[0]?.content?.parts?.[0]?.text || "Incredible performance!").trim();
                    setHighlights(prev => prev.map(h => h.id === highlight.id ? { ...h, commentary } : h));
                    return commentary;
                } catch (err) { return "What a play!"; }
                finally { setActiveAIId(null); }
            };

            const generateCommentaryAudio = async (text, speakerIndex) => {
                const voice = (speakerIndex % 2 === 0) ? "Puck" : "Kore";
                try {
                    const result = await geminiFetch('gemini-2.5-flash-preview-tts:generateContent', {
                        contents: [{ parts: [{ text: `Say with extreme excitement: ${text}` }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"], 
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } } 
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    });
                    const base64Data = result.candidates[0].content.parts[0].inlineData.data;
                    const pcmData = new Int16Array(Uint8Array.from(atob(base64Data), c => c.charCodeAt(0)).buffer);
                    return pcmToWav(pcmData, 24000);
                } catch (e) { return null; }
            };

            const exportMasterReel = async () => {
                if (highlights.length === 0) return;
                setIsExporting(true);
                setProgress(0);
                const video = videoRef.current;
                const sorted = [...highlights].sort((a, b) => a.startTime - b.startTime);
                
                // Audio mixing setup
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const dest = audioCtx.createMediaStreamDestination();
                
                const videoSource = audioCtx.createMediaElementSource(video);
                const videoGain = audioCtx.createGain();
                videoGain.gain.value = 1.0; 
                videoSource.connect(videoGain);
                videoGain.connect(dest);
                videoGain.connect(audioCtx.destination);
                
                const vStream = video.captureStream ? video.captureStream() : video.mozCaptureStream();
                const combinedStream = new MediaStream([...vStream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
                const recorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm;codecs=vp9,opus' });
                const chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.start();
                recorder.pause();
                
                for (let i = 0; i < sorted.length; i++) {
                    const h = sorted[i];
                    setProgress((i / sorted.length) * 100);
                    let commText = h.commentary || await generateCommentary(h);
                    const audioBlob = await generateCommentaryAudio(commText, i);
                    const commAudio = audioBlob ? new Audio(URL.createObjectURL(audioBlob)) : null;
                    
                    video.currentTime = h.startTime;
                    await new Promise(r => video.onseeked = r);
                    
                    video.muted = false; 
                    video.volume = 1.0;
                    
                    recorder.resume();
                    video.play();
                    
                    const commentaryDelayMs = Math.max(0, (h.timestamp - 8 - h.startTime) * 1000);
                    if (commAudio) {
                        const commSource = audioCtx.createMediaElementSource(commAudio);
                        const commGain = audioCtx.createGain();
                        commGain.gain.value = 1.8;
                        commSource.connect(commGain);
                        commGain.connect(dest);
                        setTimeout(() => commAudio.play().catch(console.warn), commentaryDelayMs);
                    }
                    
                    await new Promise(r => {
                        const check = () => { 
                            if (video.currentTime >= h.endTime || video.ended) { 
                                video.pause(); 
                                recorder.pause(); 
                                r(); 
                            } else requestAnimationFrame(check); 
                        };
                        check();
                    });
                }
                
                recorder.stop();
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `cricket_master_reel_${Date.now()}.webm`;
                    a.click();
                    setIsExporting(false); 
                    audioCtx.close();
                };
            };

            const handleFileUpload = (e) => {
                const file = e.target.files?.[0];
                if (file) { 
                    setVideoUrl(URL.createObjectURL(file)); 
                    setHighlights([]); 
                    setProgress(0); 
                }
            };

            const startScan = () => {
                if (triggers.length === 0) return;
                setIsScanning(true);
                abortRef.current = false;
                const video = videoRef.current;
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                video.playbackRate = settings.scanSpeed;
                video.play();
                const loop = () => {
                    if (abortRef.current || video.ended || video.paused) { video.playbackRate = 1.0; setIsScanning(false); return; }
                    const time = video.currentTime;
                    setProgress((time / video.duration) * 100);
                    if (time - lastDetectionTimeRef.current > 10) {
                        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                        ctx.drawImage(video, 0, 0);
                        const dRect = containerRef.current.getBoundingClientRect();
                        const sX = canvas.width / dRect.width, sY = canvas.height / dRect.height;
                        for (const t of triggers) {
                            const current = getAverageColor(ctx, { x: t.region.x * sX, y: t.region.y * sY, width: t.region.width * sX, height: t.region.height * sY });
                            if (getColorDistance(current, t.color) < settings.tolerance) {
                                lastDetectionTimeRef.current = time;
                                const startTime = Math.max(0, time - settings.preRoll);
                                setHighlights(prev => [...prev, { 
                                    id: `clip-${Date.now()}`, 
                                    timestamp: time, 
                                    label: t.label, 
                                    startTime: startTime, 
                                    endTime: Math.min(video.duration, startTime + settings.clipDuration), 
                                    thumbnail: canvas.toDataURL('image/jpeg', 0.5) 
                                }]);
                                break;
                            }
                        }
                    }
                    requestAnimationFrame(loop);
                };
                requestAnimationFrame(loop);
            };

            const saveTrigger = async () => {
                if (!currentRect || !pendingColor) return;
                const newTrigger = { id: Math.random().toString(36).substr(2, 9), label: triggerName || "ROI Point", color: pendingColor, region: currentRect, tolerance: settings.tolerance };
                const updated = [...triggers, newTrigger];
                setTriggers(updated);
                await saveProjectToCloud(updated);
                setShowModal(false); setCurrentRect(null);
            };

            return (
                <div className="flex flex-col h-screen bg-[#020617] text-slate-200 font-sans">
                    <header className="h-16 flex items-center justify-between px-6 border-b border-white/5 bg-slate-900/50 backdrop-blur-xl z-50">
                        <div className="flex items-center gap-4">
                            <div className="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center shadow-lg border border-white/10"><span className="text-xl">üèè</span></div>
                            <h1 className="text-lg font-black tracking-tighter uppercase text-white leading-none">CricketScanPro AI</h1>
                        </div>
                        <div className="flex gap-2">
                            {!videoUrl ? (
                                <label className="px-6 py-2 bg-emerald-500 text-slate-950 rounded-xl cursor-pointer font-black uppercase text-[10px] tracking-widest shadow-lg">
                                    Load Video<input type="file" accept="video/*" className="hidden" onChange={handleFileUpload} />
                                </label>
                            ) : (
                                <>
                                    <button onClick={runVisionEventScan} disabled={isVisionScanning || isScanning || isExporting} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-[10px] font-black uppercase tracking-widest border border-white/10 flex items-center gap-2">
                                        {isVisionScanning ? <i className="fa-solid fa-spinner fa-spin"></i> : "‚ú®"} Vision AI Scan
                                    </button>
                                    <button onClick={isScanning ? () => abortRef.current = true : startScan} disabled={isVisionScanning || isExporting} className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2 shadow-lg ${isScanning ? 'bg-red-500 text-white' : 'bg-emerald-600 text-white'}`}>
                                        <i className={`fa-solid ${isScanning ? 'fa-ban' : 'fa-bolt-lightning'}`}></i> {isScanning ? 'Stop' : 'ROI Scan'}
                                    </button>
                                </>
                            )}
                        </div>
                    </header>
                    <div className="flex flex-1 overflow-hidden">
                        <main className="flex-1 relative flex flex-col items-center justify-center p-6 bg-black/50">
                            {!videoUrl ? (
                                <div className="text-center space-y-4 max-w-sm"><i className="fa-solid fa-broadcast-tower text-3xl text-emerald-500/50"></i><h3 className="text-xl font-black text-white uppercase italic">Broadcaster Input</h3></div>
                            ) : (
                                <div ref={containerRef} className="relative w-full max-w-5xl aspect-video rounded-3xl overflow-hidden border border-white/10 shadow-2xl bg-black"
                                    onMouseDown={(e) => { if (!videoUrl || isScanning || isVisionScanning || isExporting) return; const r = containerRef.current.getBoundingClientRect(); setIsDrawing(true); setStartPos({ x: e.clientX - r.left, y: e.clientY - r.top }); setCurrentRect({ x: e.clientX - r.left, y: e.clientY - r.top, width: 0, height: 0 }); }} 
                                    onMouseMove={(e) => { if (!isDrawing) return; const r = containerRef.current.getBoundingClientRect(); const x = e.clientX - r.left, y = e.clientY - r.top; setCurrentRect({ x: Math.min(x, startPos.x), y: Math.min(y, startPos.y), width: Math.abs(x - startPos.x), height: Math.abs(y - startPos.y) }); }} 
                                    onMouseUp={() => { if (!isDrawing) return; setIsDrawing(false); if (currentRect?.width > 10) { const canvas = document.createElement('canvas'); canvas.width = videoRef.current.videoWidth; canvas.height = videoRef.current.videoHeight; const ctx = canvas.getContext('2d'); ctx.drawImage(videoRef.current, 0, 0); const r = containerRef.current.getBoundingClientRect(); setPendingColor(getAverageColor(ctx, { x: currentRect.x * (canvas.width / r.width), y: currentRect.y * (canvas.height / r.height), width: currentRect.width * (canvas.width / r.width), height: currentRect.height * (canvas.height / r.height) })); setShowModal(true); } else setCurrentRect(null); }}
                                >
                                    <video ref={videoRef} src={videoUrl} className="w-full h-full object-contain" controls={!isScanning && !isVisionScanning && !isExporting} crossOrigin="anonymous" />
                                    {currentRect && <div className="absolute border-2 border-emerald-500 bg-emerald-500/10 shadow-lg pointer-events-none rounded-lg" style={{ left: currentRect.x, top: currentRect.y, width: currentRect.width, height: currentRect.height }} />}
                                    {triggers.map(t => <div key={t.id} className="absolute border border-white/40 bg-white/5 backdrop-blur-sm rounded-md" style={{ left: t.region.x, top: t.region.y, width: t.region.width, height: t.region.height }}><div className="absolute -top-6 left-0 bg-slate-900 border border-white/10 rounded-md px-2 py-0.5 text-[8px] font-black uppercase text-white shadow-xl whitespace-nowrap">{t.label}</div></div>)}
                                    {(isScanning || isVisionScanning || isExporting) && <div className="absolute inset-0 bg-black/60 backdrop-blur-md flex flex-col items-center justify-center z-50 text-center space-y-4"><h4 className="text-2xl font-black text-white italic">{isExporting ? 'AI RENDERING' : 'AI SCANNING'}</h4><div className="h-1.5 w-64 bg-white/10 rounded-full overflow-hidden"><div className="h-full bg-emerald-500 transition-all duration-300" style={{ width: `${progress}%` }} /></div><button onClick={() => abortRef.current = true} className="text-red-500 uppercase text-[9px] font-black">Cancel</button></div>}
                                </div>
                            )}
                        </main>
                        <aside className="w-80 border-l border-white/5 bg-slate-900/50 backdrop-blur-2xl flex flex-col overflow-y-auto p-5 space-y-6">
                            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Control Deck</h3>
                            {[ 
                                { label: 'ROI Scan Speed', val: settings.scanSpeed, key: 'scanSpeed', min: 1, max: 10, unit: 'x' }, 
                                { label: 'Pre-Roll Buffer', val: settings.preRoll, key: 'preRoll', min: 1, max: 30, unit: 's' },
                                { label: 'Clip Duration', val: settings.clipDuration, key: 'clipDuration', min: 5, max: 35, unit: 's' } 
                            ].map(item => (
                                <div key={item.key} className="space-y-1">
                                    <div className="flex justify-between text-[10px] font-bold text-slate-400"><span>{item.label}</span><span className="text-emerald-400">{item.val}{item.unit}</span></div>
                                    <input type="range" min={item.min} max={item.max} value={item.val} onChange={e => setSettings({...settings, [item.key]: parseInt(e.target.value)})} className="w-full accent-emerald-500" />
                                </div>
                            ))}
                            <div className="pt-4 border-t border-white/5">
                                <h3 className="text-[9px] font-black text-slate-500 uppercase mb-3">Saved ROI Trackers</h3>
                                {triggers.map(t => (
                                    <div key={t.id} className="flex items-center justify-between p-2.5 bg-slate-800/40 rounded-xl mb-2 group">
                                        <div className="flex items-center gap-3"><div className="w-4 h-4 rounded" style={{ backgroundColor: `rgb(${t.color.r},${t.color.g},${t.color.b})` }} /><span className="text-[10px] font-bold">{t.label}</span></div>
                                        <button onClick={async () => { const updated = triggers.filter(tr => tr.id !== t.id); setTriggers(updated); await saveProjectToCloud(updated); }} className="text-slate-500 hover:text-red-500"><i className="fa-solid fa-trash-can"></i></button>
                                    </div>
                                ))}
                            </div>
                            <div className="pt-4 border-t border-white/5 space-y-3">
                                <h3 className="text-[9px] font-black text-slate-500 uppercase">Highlights Reel</h3>
                                {highlights.map(h => (
                                    <HighlightCard key={h.id} highlight={h} isActive={currentHighlight?.id === h.id} isProcessing={activeAIId === h.id} onSelect={(clip) => { setCurrentHighlight(clip); videoRef.current.currentTime = clip.startTime; videoRef.current.play(); }} onCommentate={generateCommentary} onDelete={(id) => setHighlights(prev => prev.filter(x => x.id !== id))} />
                                ))}
                                {highlights.length > 0 && (
                                    <button onClick={exportMasterReel} disabled={isExporting} className="w-full py-4 bg-emerald-500 text-slate-950 rounded-2xl text-[10px] font-black uppercase shadow-xl">Download Master Reel</button>
                                )}
                            </div>
                        </aside>
                    </div>
                    {showModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-xl p-8">
                            <div className="bg-slate-900 border border-white/10 p-8 rounded-[40px] shadow-2xl w-full max-w-sm text-center space-y-6">
                                <h3 className="text-lg font-black uppercase">Lock Detector</h3>
                                <div className="flex flex-col items-center gap-3 p-8 bg-black/40 rounded-3xl"><div className="w-16 h-16 rounded-2xl border-2 border-white/20" style={{ backgroundColor: `rgb(${pendingColor.r},${pendingColor.g},${pendingColor.b})` }} /><span className="text-[10px] font-bold text-emerald-400">Color Locked</span></div>
                                <input type="text" value={triggerName} onChange={e => setTriggerName(e.target.value)} className="w-full bg-black/60 rounded-xl px-4 py-3 text-xs font-black uppercase text-center outline-none" />
                                <div className="space-y-3"><button onClick={saveTrigger} className="w-full py-4 bg-emerald-500 text-slate-950 rounded-2xl font-black uppercase">Activate ROI</button><button onClick={() => { setShowModal(false); setCurrentRect(null); }} className="w-full py-2 text-slate-500 uppercase">Cancel</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>